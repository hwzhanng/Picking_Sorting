# Stage 2 (Catching) 完整规格文档

## 概述

Stage 2 是抓取阶段，机械臂底盘固定，通过控制6自由度机械臂和12自由度灵巧手完成目标物体的精细抓取。采用**不对称Actor-Critic**架构。

---

## 🧠 PPO 不对称架构

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Observation (7091维)                      │
│  ┌─────────────────┐  ┌────────────────────────────────┐   │
│  │   State (35维)   │  │      Depth Image (84×84)       │   │
│  │                 │  │           7056维                │   │
│  └────────┬────────┘  └───────────────┬────────────────┘   │
│           │                           │                     │
│           ▼                           ▼                     │
│  ┌────────────────┐         ┌─────────────────────┐        │
│  │  Actor (策略网络) │         │   Critic (价值网络)   │        │
│  │   仅使用State    │         │   State + Depth     │        │
│  └────────────────┘         └─────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

### Actor 网络 (策略网络) - 仅State输入

| 属性 | 值 |
|------|-----|
| **输入维度** | 35 (仅State) |
| **网络结构** | MLP [256, 128] → 20动作 |
| **输出** | 动作均值 μ (20维) |
| **不使用** | ❌ 深度图像 |

### Critic 网络 (价值网络) - State + Depth 输入

| 属性 | 值 |
|------|-----|
| **输入维度** | 7091 (State + Depth) |
| **State分支** | 35 → MLP [256, 128] → 128 |
| **Depth分支** | 84×84 → CNN → 256 |
| **融合层** | concat(128, 256) → 384 → 1 |

---

## 🔵 输入 (Observation)

### State 向量 (35维)

| 组件 | 维度 | 说明 |
|------|------|------|
| Arm Position | 3 | 末端执行器位置 |
| Arm Quaternion | 4 | 末端执行器姿态 |
| Arm Velocity | 3 | 末端执行器速度 |
| Arm Joints | 6 | 机械臂6关节角度 |
| Object Position | 3 | 目标物体相对位置 |
| Hand Joints | 12 | 手部12关节角度 |
| Touch Sensors | 4 | 4个手指力传感器 |
| **总计** | **35** | - |

### Depth Image (7056维)

| 属性 | 值 |
|------|-----|
| 分辨率 | 84×84 |
| 通道 | 1 (深度) |
| 数据类型 | uint8 (0-255) |
| 相机 | 腕部相机 (wrist) |
| 噪声 | Gaussian + Dropout + Salt-Pepper |

---

## 🟢 输出 (Action)

| 组件 | 维度 | 范围 | 说明 |
|------|------|------|------|
| Base | 2 | **强制=0** | 底盘锁定 |
| Arm | 6 | ±0.05 rad | 机械臂关节增量 |
| Hand | 12 | 关节限位内 | 手部关节目标 |
| **总计** | **20** | - | 实际有效18维 |

---

## 🟡 奖励函数

### 正向奖励

| 奖励项 | 范围 | 公式/条件 |
|--------|------|-----------|
| **Reaching** | 0 ~ 1.0 | `1.0 * (1 - tanh(2.0 * d))` |
| **Orientation** | 0 ~ 2.0 | `alignment^power * 2.0` (ee < 0.5m时) |
| **Grasp** | -10 ~ 9.0 | 力范围奖励，见下表 |
| **Perturbation** | -5, 0, +10 | 扰动测试结果 |
| **Success** | 0 或 +50 | 稀疏成功奖励 |

#### Grasp 奖励详细

| 总接触力 | 奖励值 |
|----------|--------|
| 0 ~ 0.01N | 0 |
| 0.01 ~ 1.0N | `0.5 * force` |
| 1.0 ~ 2.5N | `5.0 + fingers * 1.0` (最高9.0) |
| > 2.5N | `max(-10, 5.0 - 2.0*(force - 2.5))` |

### 负向惩罚

| 惩罚项 | 范围 | 公式/条件 |
|--------|------|-----------|
| **Impact** | -30 ~ 0 | `max(-30, -6*(exp(5*(v-0.3))-1))` |
| **Regularization** | ~ -0.1 | `-norm(ctrl) * 0.01` |
| **Collision** | -10 或 0 | 失败终止时 |
| **Plant Stem** | -1 ~ -20 | 课程学习动态调整 |
| **Plant Leaf** | ~ -0.1 | `-0.1 * (1 + ee_vel)` |
| **Action Rate** | ~ -0.5 | `-norm(Δaction) * 0.05` |

---

## 🏆 成功条件

```
成功 = 多手指稳定软力接触 2秒 + 扰动测试通过
```

| 条件 | 阈值 |
|------|------|
| 每手指力范围 | 0.2N ~ 1.0N |
| 最少手指数 | ≥ 3个 |
| 持续时间 | 2.0秒 |
| 扰动测试 | 滑移 < 1cm |

---

## 📈 课程学习

| 参数 | 起始值 | 结束值 | 阶段 |
|------|--------|--------|------|
| `collision_stem` | -1.0 | -20.0 | 0~6M步 |
| `orient_power` | 1.0 | 4.0 | 0~6M步 |

---

## ⚙️ 关键配置

| 配置项 | 值 |
|--------|-----|
| Episode时间 | 2.5秒 |
| 物体生成范围 | 0.05~2.0m |
| 控制频率 | 每20仿真步1动作 |
| 学习率 | 3e-4 |
| Horizon | 512 |
| Minibatch | 512 |
