# Picking_Sorting é¡¹ç›®æ¶æ„è¯´æ˜æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

ä¸¤é˜¶æ®µå†œä¸šé‡‡æ‘˜å¼ºåŒ–å­¦ä¹ é¡¹ç›®ï¼Œä½¿ç”¨ AVP (Asymmetric Value Propagation) æŠ€æœ¯è¿æ¥ä¸¤ä¸ªé˜¶æ®µã€‚

**è®­ç»ƒé¡ºåº: Stage 2 â†’ Stage 1** (Stage 1 åŠ è½½ Stage 2 Critic è¿›è¡Œ AVP å¥–åŠ±)

---

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
catch_it/
â”œâ”€â”€ train_stage1.py              # Stage 1 è®­ç»ƒå…¥å£
â”œâ”€â”€ train_stage2.py              # Stage 2 è®­ç»ƒå…¥å£
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ config_stage1.yaml       # Stage 1 é…ç½®
â”‚   â”œâ”€â”€ config_stage2.yaml       # Stage 2 é…ç½®
â”‚   â””â”€â”€ env/DcmmCfg.py           # ç¯å¢ƒå‚æ•° + AVPé…ç½®
â”œâ”€â”€ gym_dcmm/
â”‚   â”œâ”€â”€ envs/
â”‚   â”‚   â”œâ”€â”€ stage1/
â”‚   â”‚   â”‚   â”œâ”€â”€ DcmmVecEnvStage1.py     # Stage 1 ç¯å¢ƒ
â”‚   â”‚   â”‚   â””â”€â”€ RewardManagerStage1.py  # Stage 1 å¥–åŠ± (å«AVP)
â”‚   â”‚   â”œâ”€â”€ stage2/
â”‚   â”‚   â”‚   â”œâ”€â”€ DcmmVecEnvStage2.py     # Stage 2 ç¯å¢ƒ
â”‚   â”‚   â”‚   â””â”€â”€ RewardManagerStage2.py  # Stage 2 å¥–åŠ±
â”‚   â”‚   â”œâ”€â”€ observation_manager.py      # è§‚æµ‹å¤„ç† (å…±äº«)
â”‚   â”‚   â”œâ”€â”€ control_manager.py          # æ§åˆ¶ç®¡ç† (å…±äº«)
â”‚   â”‚   â””â”€â”€ render_manager.py           # æ¸²æŸ“ç®¡ç† (å…±äº«)
â”‚   â””â”€â”€ algs/ppo_dcmm/
â”‚       â”œâ”€â”€ stage1/
â”‚       â”‚   â”œâ”€â”€ PPO_Stage1.py           # Stage 1 PPO
â”‚       â”‚   â””â”€â”€ ModelsStage1.py         # Stage 1 ç½‘ç»œ
â”‚       â”œâ”€â”€ stage2/
â”‚       â”‚   â”œâ”€â”€ PPO_Stage2.py           # Stage 2 PPO
â”‚       â”‚   â””â”€â”€ ModelsStage2.py         # Stage 2 ç½‘ç»œ (å«Critic)
â”‚       â”œâ”€â”€ experience.py               # ç»éªŒç¼“å†² (å…±äº«)
â”‚       â””â”€â”€ utils.py                    # å·¥å…·å‡½æ•° (å…±äº«)
â””â”€â”€ assets/
    â”œâ”€â”€ checkpoints/avp/
    â”‚   â””â”€â”€ stage2_critic.pth           # AVP é¢„è®­ç»ƒæƒé‡
    â””â”€â”€ urdf/                           # MuJoCo æ¨¡å‹
```

---

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯: AVP (Asymmetric Value Propagation)

### é—®é¢˜

Stage 1 ä»…é "è·ç¦»å¥–åŠ±"æ— æ³•çŸ¥é“å½“å‰ä½ç½®æ˜¯å¦ä¾¿äºåç»­æŠ“å–ã€‚

### è§£å†³æ–¹æ¡ˆ

```
              Stage 1 è®­ç»ƒæµç¨‹
                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                         â”‚
  åŸå§‹å¥–åŠ±                    AVPå¥–åŠ±
  (è·ç¦»ã€ç¢°æ’ç­‰)                 â”‚
      â”‚                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
      â”‚                æ„é€ è™šæ‹Ÿè§‚æµ‹:
      â”‚                [å°±ç»ªå§¿æ€æ‰‹è‡‚]
      â”‚                [çœŸå®ç‰©ä½“ä½ç½®]
      â”‚                [çœŸå®æ·±åº¦å›¾åƒ]
      â”‚                    â”‚
      â”‚              Stage 2 Critic
      â”‚              (é¢„è®­ç»ƒ,å†»ç»“)
      â”‚                    â”‚
      â”‚              value_estimate
      â”‚                    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         æ€»å¥–åŠ± = åŸå§‹å¥–åŠ± + Î» Ã— AVPå¥–åŠ±
```

### å…³é”®ä»£ç ä½ç½®

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `configs/env/DcmmCfg.py:avp` | AVPé…ç½®ç±» (å¼€å…³/æƒé‡/è·¯å¾„) |
| `RewardManagerStage1._load_stage2_critic()` | åŠ è½½Stage 2 Critic |
| `RewardManagerStage1.construct_virtual_obs()` | æ„é€ è™šæ‹Ÿè§‚æµ‹ |
| `RewardManagerStage1.compute_avp_reward()` | è®¡ç®—AVPå¥–åŠ± |

---

## ğŸ”„ æ•°æ®æµ

### Stage 1 è®­ç»ƒ

```
è§‚æµ‹ â†’ [çŠ¶æ€ + æ·±åº¦å›¾]
  â”‚
ç¥ç»ç½‘ç»œ (CNN + MLP)
  â”‚
åŠ¨ä½œ â†’ [åº•ç›˜é€Ÿåº¦ + æ‰‹è‡‚å…³èŠ‚å¢é‡]
  â”‚
MuJoCo æ­¥è¿›
  â”‚
â”Œâ”€å¥–åŠ±è®¡ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ°è¾¾å¥–åŠ±: tanh(distance)           â”‚
â”‚ 2. åº•ç›˜å®šä½: exp(-dist_errorÂ²)         â”‚
â”‚ 3. æœå‘å¥–åŠ±: alignment^orient_power    â”‚
â”‚ 4. ç¢°æ’æƒ©ç½š: æ ‘å¹²(-1~-20) / æ ‘å¶(è½»å¾®) â”‚
â”‚ 5. (å¯é€‰) AVPå¥–åŠ±: Î» Ã— value_estimate  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Stage 2 è®­ç»ƒ (å…ˆè®­ç»ƒ)

```
è§‚æµ‹ â†’ [çŠ¶æ€ + æ·±åº¦å›¾]
  â”‚
ç¥ç»ç½‘ç»œ (CNN + MLP)
  â”‚
åŠ¨ä½œ â†’ [æ‰‹è‡‚å…³èŠ‚å¢é‡ + çµå·§æ‰‹åŠ¨ä½œ]
  â”‚
å¥–åŠ±: æ¥è§¦ + ç¨³å®šæ€§ + é€Ÿåº¦æƒ©ç½š
```

**Stage 2 å®Œå…¨ç‹¬ç«‹è®­ç»ƒï¼Œä¸ä¾èµ– Stage 1ã€‚**
è®­ç»ƒå®Œæˆåï¼Œå¯¼å‡º Critic ç”¨äº Stage 1 çš„ AVPã€‚

```bash
cp outputs/Dcmm_Catch/.../best.pth assets/checkpoints/avp/stage2_critic.pth
```

---

## âš™ï¸ AVP é…ç½® (DcmmCfg.py)

```python
class avp:
    enabled = True           # ä¸»å¼€å…³
    lambda_weight = 0.5      # å¥–åŠ±æƒé‡
    gate_distance = 1.5      # è·ç¦»é—¨é™ (m)
    checkpoint_path = "assets/checkpoints/avp/stage2_critic.pth"
    ready_pose = [0.0, -0.5, 0.0, 1.5, 0.0, 0.0]  # è™šæ‹Ÿå°±ç»ªå§¿æ€
    state_dim = 35           # Stage 2 çŠ¶æ€ç»´åº¦
    img_size = 84            # æ·±åº¦å›¾å°ºå¯¸
```

---

## ğŸ“Š å¥–åŠ±å‡½æ•°

### Stage 1 (RewardManagerStage1.py)

| åˆ†é‡ | å…¬å¼ | æƒé‡ |
|------|------|------|
| åˆ°è¾¾ | `1 - tanh(2d)` | 1.0 |
| åº•ç›˜å®šä½ | `exp(-5(d-0.8)Â²)` | 1.0 |
| æœå‘ | `max(0,align)^power Ã— 2` | åŠ¨æ€ 1â†’4 æ¬¡æ–¹ |
| æ¥è§¦ | `10 - 4Ã—speed` | 10.0 |
| æ ‘å¹²ç¢°æ’ | åŠ¨æ€ | -1 â†’ -20 |
| æ ‘å¶ç¢°æ’ | `-0.5Ã—(1+vel)` | -0.5 |
| **AVP** | `Î» Ã— critic(virtual_obs)` | 0.5 |

### Stage 2 (RewardManagerStage2.py)

| åˆ†é‡ | è¯´æ˜ |
|------|------|
| æ¥è§¦å¥–åŠ± | æ‰‹æŒ‡æ¥è§¦ç‰©ä½“ |
| é€Ÿåº¦æƒ©ç½š | `-6Ã—(exp(5Ã—max(0,v-0.3))-1)` |
| æ‰°åŠ¨æµ‹è¯• | 2-5NéšæœºåŠ›ï¼Œæ»‘ç§»<1cmå¥–åŠ±+10 |

---

## ğŸ“ è®­ç»ƒæµç¨‹

### Step 1: Stage 2 (ç‹¬ç«‹è®­ç»ƒçµå·§æ‰‹)

```bash
python train_stage2.py num_envs=16
```

### Step 2: å¯¼å‡º Critic ç”¨äº AVP

```bash
cp outputs/Dcmm_Catch/.../best.pth assets/checkpoints/avp/stage2_critic.pth
```

### Step 3: Stage 1 (ä½¿ç”¨ AVP)

```bash
python train_stage1.py num_envs=16      # AVP è‡ªåŠ¨åŠ è½½ Stage 2 Critic
python train_stage1.py avp_enabled=False # æ¶ˆèå®éªŒåŸºçº¿
```

### éªŒè¯ (å•çª—å£)

```bash
python train_stage1.py test=True num_envs=1 viewer=True checkpoint_tracking="..."
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

1. **ä¸¤é˜¶æ®µåˆ†ç¦»**: Stage 1/2 ç‹¬ç«‹æ–‡ä»¶ç»“æ„ï¼Œä¾¿äºè°ƒè¯•
2. **AVP è¿æ¥**: Stage 2 Critic ä¸º Stage 1 æä¾›æŠ“å–å¯è¡Œæ€§ä¿¡å·
3. **åŠ¨æ€è¯¾ç¨‹**: 0â†’6Mæ­¥æ¸è¿›è°ƒæ•´ç¢°æ’æƒ©ç½šå’Œæœå‘è¦æ±‚
4. **å…³èŠ‚ç©ºé—´æ§åˆ¶**: ç›´æ¥è¾“å‡º6ç»´å…³èŠ‚å¢é‡ï¼Œé¿å…IKä¸ç¨³å®š
5. **è™šæ‹Ÿè§‚æµ‹**: å›ºå®šæ‰‹è‡‚å§¿æ€ + çœŸå®ç‰©ä½“ä½ç½® + çœŸå®æ·±åº¦
